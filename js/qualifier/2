var Dom = YAHOO.util.Dom;
var loadingDialog = null;
var advancedOptionsOverlay;



String.prototype.zeroPad = function( num )
{
    var ret = this;
    while( ret.length < num )
        ret = "0" + ret;
    return ret;
};


Number.prototype.toTimeOfDay = function() {
    return parseInt( this / (60*60)).toString().zeroPad(2) + ":" +  (Math.round(this /60) % 60).toString().zeroPad(2);
};

YAHOO.util.Event.addListener(window, "load", qualifierInit);

function qualifierInit( )
{
    YAHOO.util.Event.addListener( "add_course", "click", addCourse );
    YAHOO.util.Event.addListener( "submit_courses", "click", submitCourses );
    YAHOO.util.Event.addListener( "show_conflicts", "click", toggleConflicts);
    YAHOO.util.Event.addListener( "create_pdf", "click", createPDF );

    //Defining advanced overlay
    document.getElementById("advanced_options").setAttribute("style", "");
/*
    overlay2 = new YAHOO.widget.Overlay("advanced_options", { width:"500px" } );
    overlay2.render();
*/

    overlay2 = new YAHOO.widget.Overlay("advanced_options", { context:["advanced_options_toggle","bl","br"],
                                                                                  visible:false,
                                                                                 width:"400px" } );
    overlay2.render( );



    YAHOO.util.Event.addListener( "advanced_options_toggle", "click", toggleAdvancedOptions );
}

toggleAdvancedOptions.showing = false;
function toggleAdvancedOptions(e)
{
    YAHOO.util.Event.preventDefault(e);
    sections = Dom.getElementsByClassName( "options_sections" );
    if( toggleAdvancedOptions.showing ) 
    {
        overlay2.hide();
        toggleAdvancedOptions.showing = false;
        for( var i = 0; i < sections.length; i++ ) 
        {
            sections[i].setAttribute("style", "display:none;" );    
        }  
    }
    else
    {
        overlay2.show();
        console.dir( sections );
        for( var i = 0; i < sections.length; i++ ) 
        {
            sections[i].setAttribute("style", "display:inline;" );    
        }  
        toggleAdvancedOptions.showing = true;
    }
}

function initLoadingDialog()
{
    if( loadingDialog )
    {
        return;
    }
    loadingDialog = 
            new YAHOO.widget.Panel("loadingDialog",  
                { width:"240px", 
                  fixedcenter:true, 
                  close:false, 
                  draggable:false, 
                  zindex:4,
                  modal:true,
                  visible:false
                } 
            );

    loadingDialog.setHeader("Patience is a virtue...");
    loadingDialog.setBody('<img src="images/loading.gif" />');
    loadingDialog.render(document.body);
}

function showLoadingDialog()
{
    initLoadingDialog();
    loadingDialog.show();
}

function hideLoadingDialog()
{
    initLoadingDialog();
    loadingDialog.hide();
}

function addCourse( e )
{
    YAHOO.util.Event.preventDefault(e);

    var course_list = document.getElementById("course_list");

    var old_course =  Dom.getElementsByClassName('course','div', course_list )[0];
    var new_course = old_course.cloneNode( true );
    
    course_list.appendChild( new_course );
}



function getCoursesObject()
{

    var course_form = document.getElementById("course_form");
    
    var courses = [];
    var course_nodes = Dom.getElementsByClassName( "course", null, course_form );
    for( var i = 0; i < course_nodes.length; i++ )
    {
        courseObject = serializeFromRoot( course_nodes[i], true );
        optionsSpan = Dom.getChildrenBy( course_nodes[i], function(e) { return e.className == "options"; } )[0]
        courseObject["options"] = serializeFromRoot( optionsSpan, false );

        courses.push( courseObject );
    }
    

    return courses;
}

function serializeFromRoot( root, first_level )
{
    var options = {}
    var inputElements;
    var selectElements;

    if( first_level == true )
    {
        inputElements = Dom.getChildrenBy( root, function(e) { return e.tagName == "INPUT"; } )
        selectElements= Dom.getChildrenBy( root, function(e) { return e.tagName == "SELECT"; } )
    }
    else
    {
        inputElements = root.getElementsByTagName("input");
        selectElements = root.getElementsByTagName("select");
    }

    for( i =0; i< inputElements.length; i++ ) 
    {
        var option = inputElements[i];
        if( option.name.indexOf( "[]" ) == option.name.length - 2 )
        {
            var name = option.name.substr( 0, option.name.length -2  );
            if( options[name] == undefined )
            {
                options[name] = [];
            }

            options[name].push( option.value );
        }
        else if( option.type == "checkbox" )
        {
            options[option.name] = option.checked;
        }
        else
        {
            options[ option.name ] = option.value;
        }
    }

    for( i=0; i< selectElements.length; i++ )
    {
        var select = selectElements[i];
        var selectChildren = select.getElementsByTagName( "option" );

        for( var j =0;j < selectChildren.length; j++ )
        {
            var option = selectChildren[j];
            if( option.selected  )
            {
                options[ select.name ] = option.value;
            }
        }
    }
    return options;
}

function submitCourses( e ) 
{

    YAHOO.util.Event.preventDefault(e);

    var course_form = document.getElementById("course_form");
    var advanced_options = document.getElementById("advanced_options");
    var options = serializeFromRoot( advanced_options ); 
    var i = 0;


    var requestObject = 
    {
        "school": course_form.school.value,
        "term" : course_form.term.value,
        "options" : options,
        "courses": getCoursesObject()
    };

    document.getElementById("error_area").innerHTML = "";
    document.getElementById("info_area").innerHTML = "";
    document.getElementById("too_many_explanation").setAttribute("style","display:none;");

    showLoadingDialog();
    hideConflicts();
    hideCalendar();
    hideCatalogInformation();
    hideQualifierGrid();
    var pdfDiv = document.getElementById("create_pdf_div");
    pdfDiv.setAttribute("style", "display:none;" );
    YAHOO.util.Connect.asyncRequest( 'POST', "qualifyCGI.py", 
                    { 
                        success: qualifyCallback,
                        failure: qualifyErrorCallback
                    },
                    "json=" + escape(YAHOO.lang.JSON.stringify( requestObject ) ));
}

function displayInfo(infoString)
{
    var infoArea = document.getElementById( "info_area" );
    infoArea.innerHTML = "<br />" + infoString.replace( / /g, "&nbsp;" ).replace( /\n/g, "<br />" );
}

function displayError(errorString)
{
    var errorArea = document.getElementById( "error_area" );
    errorArea.innerHTML = "Errors: <br />" + errorString.replace(/ /g, "&nbsp;" ).replace( /\n/g, "<br />" );
}

function handleQualifierException( exception )
{
    if( exception.name == "TooManySchedulesException" )
    {
        var tooManyArea = document.getElementById( "too_many_explanation" );
        var tooManyNumber = document.getElementById( 'too_many_number' );

        tooManyNumber.innerHTML =  exception.numClasses;
        tooManyArea.setAttribute("style", "display: block;" );
    }
    else
    {
        displayError( exception.string );
    }
}


function qualifyCallback( response )
{
    hideLoadingDialog();
    try{
        var data = YAHOO.lang.JSON.parse( response.responseText );
    } catch( e ) {
        displayError( "Invalid response from server");
        return;
    }

    if( data.error != undefined )
    {
        displayError( data.error );
    }
    if( data.exception != undefined )
    {
        handleQualifierException( data.exception );
    }

    if( data.error == undefined && data.exception == undefined )
    {
        var info = data.info;

        toggleConflicts.conflicts = data.result.conflicts;
        

        if( info != "" )
            displayInfo( info );

        if( data.result.catalogs.length ==0 )
        {
            displayError( "No valid schedules found" );
        }
        else
        {
            createQualifierGrid(data.result );
        }
    }
}

function hideQualifierGrid() 
{
    var qualifierGridLocation = document.getElementById("qualifier_grid");

    qualifierGridLocation.innerHTML = "";
}

function createQualifierGrid( data ) 
{
    

    var i;
    var j;
    var columns = [];
    var gridData = [];
    var gridFields = [];
    var metricTypes = {};

    rowSelected.courses= [];
    rowSelected.metrics = [];
    for( var course in data.courses )
    {
        var resolved = data.courses[course];
        /* Disabled for now, let's see if we need them
        columns.push(
        {
            key: resolved.courseName,
            label: resolved.courseName
        });
        */

        
        rowSelected.courses.push( resolved.courseName);

        gridFields.push( resolved.courseName );
    }   

    //ID column
    columns.push( {
        key: "id",
        label: "Catalog #"
    });
    gridFields.push( "id" );

    for( i= 0; i < data.valid_metrics.length; i++ )
    {
        var metric = data.valid_metrics[i];
        columns.push( {
            key: metric.key,
            label:  metric.name,
            sortable: true
        });

        rowSelected.metrics.push( metric.key );

        metricTypes[ metric.key ]  = metric.type;
        gridFields.push( data.valid_metrics[i] );
    }

    for( i =0; i < data.catalogs.length; i++ )
    {
        var catalog = data.catalogs[i];
        var row = {};

        row.id = i +1;

        for( j =0; j < catalog.sections.length; j++ )
        {
            var section = catalog.sections[j];
            row[section.courseName] = section.sectionName;
        }

        for( var metric in  catalog.metrics )
        {
            if( catalog.metrics[metric] == null )
            {
                row[metric] = "";
            }
            else if( catalog.metrics[metric] && (metricTypes[metric] == "time" || metricTypes[metric] == "duration" ))
            {
                row[metric]  = catalog.metrics[metric].toTimeOfDay();
            }
            else if( metricTypes[metric] == "number" )
            {
                if( Math.round(catalog.metrics[metric]) != catalog.metrics[metric] )
                {
                    row[metric]  = catalog.metrics[metric].toFixed(2);
                }
                else
                {

                    row[metric]  = catalog.metrics[metric];
                }
            }
            else
            {

                row[metric]  = catalog.metrics[metric];
            }
        }
        
        gridData.push( row );
    }

    var myDataSource = new YAHOO.util.DataSource(gridData);
    myDataSource.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
    myDataSource.responseSchema = {
        fields: gridFields
        };

    var myDataTable = new YAHOO.widget.DataTable("qualifier_grid", columns, myDataSource,
        {
            caption: "Click row for schedule details",
            selectionMode: "single"
        }); 
    myDataTable.subscribe( "rowClickEvent", myDataTable.onEventSelectRow);
    myDataTable.subscribe( "rowClickEvent", rowSelected ); 
    myDataTable.subscribe( "rowMouseoverEvent", myDataTable.onEventHighlightRow);
    myDataTable.subscribe( "rowMouseoutEvent", myDataTable.onEventUnhighlightRow);

    rowSelected.dataTable = myDataTable;
    rowSelected.responseData =  data;
}

function rowSelected(e ) 
{
    var i;
    var dataTable=  rowSelected.dataTable;
    var responseData = rowSelected.responseData;
    var rowData =  dataTable.getRecord( e.target).getData() ;
    var courses = rowSelected.courses;
    var sections = {};

    for( i = 0; i < courses.length; i++ ) 
    {
        var course = courses[i];
        sections[ course] = rowData[course];
    }

    createCalendar( responseData.courses, sections );
    createCatalogInformation( rowData, sections , responseData );
}

function hideCatalogInformation()
{
    var informationLocation = document.getElementById("catalog_information");
    informationLocation.innerHTML = ""; 
}

function createPDF( e)
{
    YAHOO.util.Event.preventDefault(e);
    var request = {
        row_data : createPDF.rowData,
        sections: createPDF.sections,
        response_data: createPDF.responseData
    };

    document.pdf_form.json.value = YAHOO.lang.JSON.stringify(request);
    document.pdf_form.submit();

}

function createCatalogInformation( rowData, sections, responseData )
{
    var i;
    var informationLocation = document.getElementById("catalog_information");
    
    hideCatalogInformation();

    var pdfDiv = document.getElementById("create_pdf_div");
    pdfDiv.setAttribute("style", "" );

    createPDF.rowData = rowData;
    createPDF.sections = sections;
    createPDF.responseData = responseData;


    /* This is just repeated info, I'll hide it for now


    var catalogMetrics = document.createElement( "div" );
    catalogMetrics.setAttribute("class", "metric_detail_list" );
    catalogMetrics.innerHTML = "<h3> Metrics </h3>";

    for( i=0; i< responseData.valid_metrics.length; i++ ) 
    {
        var metric = responseData.valid_metrics[i];
        var metricNode = document.createTextNode( metric.name + ": " + 
                            rowData[metric.key]);
        catalogMetrics.appendChild( metricNode );
        catalogMetrics.appendChild( document.createElement( "br" ) );

    }
    */

    var courseInfo = document.createElement( "div" );
    courseInfo.setAttribute("class", "course_detail_list");
    courseInfo.innerHTML = "<h3> Courses </h3> ";

    for( var course in sections )
    {
        var courseHTML = document.createElement( "div" );
        courseHTML.setAttribute("class", "course_details");
        courseHTML.innerHTML = "<h4>" +  course + "</h4>";

        var detailedSection = responseData.courses[course].sections[sections[course]];

        for(  i=0; i < responseData.section_information.length; i++ )
        {
            var sectionInfo = responseData.section_information[i]; 
            var personalInfo = detailedSection[sectionInfo.key];
            if( !personalInfo || personalInfo == "" || personalInfo == null ) 
            {
                continue;
            }
            courseHTML.innerHTML += "<span class='course_detail_header'>" + sectionInfo.name + ":</span> " + detailedSection[sectionInfo.key] + " <br />";
        }

        courseInfo.appendChild( courseHTML );
    }


    informationLocation.appendChild( courseInfo);
    informationLocation.appendChild( document.createElement( "br" ) );
    //informationLocation.appendChild( catalogMetrics );
}

function hideCalendar()
{
    var calendarLocation = document.getElementById("qualifier_calendar");
    calendarLocation.innerHTML = "";
}

function createCalendar( courseData, sections ) 
{   
    var calendarLocation = document.getElementById("qualifier_calendar");

    hideCalendar();
    
    var validDays = [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ];
    var stepSize = 30*60;
    var minStartTime = 9999999;
    var maxEndTime = 0;


    // First pass to determine the "width" and "height" of the table
    for( var section in sections )
    {
        var sectionInfo = courseData[section].sections[sections[section]];
        var validTimes = sectionInfo.valid_times;
        for( var j =0; j< validTimes.length; j++ )
        {
            if( validTimes[j][0] )
            {
                minStartTime = Math.min( minStartTime, validTimes[j][0] );
                maxEndTime = Math.max( maxEndTime, validTimes[j][1] );
            }
        }
    }

    var table = document.createElement( "table" );
    var tableBody = document.createElement( "tbody" );
    var tableHeader = document.createElement( "thead" );
    var headerRow  =  document.createElement( "tr" );
    var timeHeader = document.createElement( "th" );
    timeHeader.appendChild( document.createTextNode( "Time" ) );
    headerRow.appendChild( timeHeader );
    for( i =0; i< validDays.length; i++ )
    {
        var headerNode = document.createElement( "th" );
        var textNode = document.createTextNode( validDays[i] );
        headerNode.appendChild( textNode );
        headerRow.appendChild( headerNode );
    }
    tableHeader.appendChild( headerRow );
    table.appendChild( tableHeader );

    var realStartTime = 8*60*60;
    var realEndTime = 20*60*60;
        
    if( minStartTime < realStartTime )
    {
        realStartTime = minStartTime - 2*60*60;
    }
    if( maxEndTime > realEndTime )
    {
        realEndTime = maxEndTime + 1*60*60;
    }
    
    for( i = realStartTime; i <= realEndTime; i+= stepSize )
    {
        var row = document.createElement( "tr" );
        var tdNode = document.createElement("td" );
        tdNode.appendChild( document.createTextNode( i.toTimeOfDay() ) );
        tdNode.className = "time";
        row.appendChild( tdNode );
        for( j = 0; j < validDays.length; j++ )
        {
            var tdNode = document.createElement("td" );
            tdNode.innerHTML = "&nbsp;";
            tdNode.className = "empty";
            row.appendChild(  tdNode );
        }
        tableBody.appendChild( row );
    }

    var tableRows = tableBody.childNodes;

    //Second time to fit into the proper bucket
    var startBucket = parseInt( realStartTime / stepSize );
    var endBucket = parseInt( realEndTime / stepSize );
    i = 0; 
    for( var course in sections )
    {
        var courseInfo = courseData[course];
        var sectionInfo = courseInfo.sections[sections[course]];
        var validTimes = sectionInfo.valid_times;
        for( j =0; j< validTimes.length; j++ )
        {
            var startTime = validTimes[j][0];
            var endTime = validTimes[j][1];
            if( startTime )
            {
                for( var k = startTime; k <= endTime; k += stepSize )
                {
                    var bucket = parseInt(k / stepSize) - startBucket;
                    var cols = tableRows[bucket + 1].childNodes;
                    if( k == startTime )
                    {
                        cols[j + 1].appendChild( document.createTextNode( courseInfo.courseName + " " ) );
                    }
                    else if ( k == startTime + stepSize )
                    {
                        cols[j + 1].appendChild( document.createTextNode( sectionInfo.room + " " ) );
                    }
                    else
                    {
                        cols[j + 1].appendChild( document.createTextNode(  " " ) );
                    }

                    cols[j + 1].className = "classNum" + i;
                }

            }
        }
        i++;
    }

    table.appendChild( tableBody );
    table.id = "calendarTable";
    table.cellPadding = 0;
    table.cellSpacing = 0;
    calendarLocation.appendChild ( table );

}

function hideConflicts()
{

    var conflictDiv = document.getElementById("conflict_area");
    var showConflictsText = document.getElementById( "show_conflicts" );

    if( toggleConflicts.showing )
    {
        conflictDiv.innerHTML = ""; 
        showConflictsText.innerHTML = "Show conflicts";
        toggleConflicts.showing = false; 
    }
}

toggleConflicts.showing = false;

function toggleConflicts( e )
{
    YAHOO.util.Event.preventDefault(e);
    if( toggleConflicts.conflicts == undefined) 
    {
        return;   
    }
    var conflictingCourses = toggleConflicts.conflicts.courses;
    var conflictingMessages = toggleConflicts.conflicts.messages;

    var conflictDiv = document.getElementById("conflict_area");
    var showConflictsText = document.getElementById( "show_conflicts" );

    if( toggleConflicts.showing )
    {
        hideConflicts();
    }
    else
    {
        var i;
        for(  i = 0; i < conflictingCourses.length; i++ )
        {
            var course1 = conflictingCourses[i][0];
            var course2 = conflictingCourses[i][1];

            var newText = document.createTextNode( course1.courseName + " (" + course1.sectionName + ")"
                            + " conflicts with " + course2.courseName + " (" + course2.sectionName + ")" );
            conflictDiv.appendChild( newText );
            conflictDiv.appendChild( document.createElement( "br" )  );
        }

        for( i = 0; i< conflictingMessages.length; i++ )
        {
            var message = conflictingMessages[i];

            var newText = document.createTextNode( message );

            conflictDiv.appendChild( newText );
            conflictDiv.appendChild( document.createElement( "br" ) );
        }

        showConflictsText.innerHTML = "Hide conflicts";
        toggleConflicts.showing = true; 
    }
}

function qualifyErrorCallback()
{

   hideLoadingDialog();
   displayError( "Error communicating with server"); 
}
